= form_for message, html: { id: 'send-kiito' } do |f|
  = hidden_field_tag 'message[to]'
  .dialog-inverted
    .users-list
      %span.choose-secondary
        +
      .who-selection.hidden
        .user-search
          .user-select
            = text_field_tag :search_to, nil, placeholder: 'Search here!'
            /%span.name
            /  Haro
            /%span.email
            /  jesus.haro@crowdint.com
        .add
        .remove
      .who
        = t('.to_who')
        %br
        %span.optional
          = t('.optional')
        %span.arrow-right
    .kiitos-list
      %span.choose
        +
      .which
        %span.arrow-left
        = t('.which')
      .list-wrapper.hidden
        %ul
          - Kiitos::Kiito.all.map { |k| [k.title, k.id, k.image] }.each do |title, id, image|
            %li
              %span.badge
                = image_tag 'kiitos/PNG/category.png'
              = f.label "kiitos_kiito_id_#{id}", title
              = f.radio_button :kiitos_kiito_id, id

  .receiver-pic.badge-inverted
  .message-info
    %h3= t('kiitos.kiito')
    .dialog-dark
      = f.text_area :message, placeholder: "#{t('.your_comment')}"
    %span.by
      = t('.by')
      = current_user.name
    %span.count
    %span.date-now
      = pretty_date Time.now
  .send
    = f.submit t('.submit'), class: 'btn'
    .anonymous
      = f.check_box :anonymous
      = f.label :anonymous

  :coffee
    $('.kiitos-list').delegate '.choose', 'click', ->
      $('.kiitos-list .list-wrapper').toggleClass 'hidden'
      $('.kiitos-list .choose').toggleClass 'btn-active'

    $('.users-list').delegate '.choose-secondary', 'click', ->
      $('.users-list .who-selection').toggleClass 'hidden'
      $('.users-list .choose-secondary').toggleClass 'btn-active'

    $('#search_to').typeahead
      name: 'users'
      prefetch:
        url: '/kiitos/users'
        ttl: 5000

    $('#search_to').on 'typeahead:autocompleted typeahead:selected', (e, data)->
      $('#message_to').val data.id

    count = ->
      length = $('#message_message').val().length
      $('.count').text(140 - length)

    count()

    $('#message_message').keyup ->
      count()
